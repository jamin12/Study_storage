
## NAT란?
### **IP 주소가 부족하던 시절, NAT는 왜 등장했는가?**

한때는 인터넷에 연결된 기기마다 고유한 IP 주소를 가져야 했습니다. 하지만 IPv4 주소는 한정되어 있고, 점점 늘어나는 컴퓨터와 스마트폰, IoT 기기들을 수용하기엔 턱없이 부족했습니다. 이 문제를 해결하기 위해 탄생한 것이 바로 NAT입니다.

NAT는 말 그대로 ‘주소를 변환’하는 기술입니다. 즉, 외부 인터넷과 내부 네트워크 사이에서 IP 주소를 바꾸어주는 중개자 역할을 하죠. 공유기에서 NAT는 핵심 기능으로 작동합니다. 외부에는 하나의 공인 IP만 보이게 하면서, 그 안에서 수많은 사설 IP 기기들이 인터넷을 함께 사용할 수 있도록 해줍니다.

### **NAT는 단순한 주소 변환기가 아니다**

NAT는 IP 주소뿐 아니라 **포트 번호**도 함께 관리합니다. 
이를 통해 동일한 공인 IP 주소를 사용하는 여러 장치들의 통신을 동시에 구분하고 처리할 수 있습니다.

예를 들어 같은 가정 내에서 두 대의 노트북이 각각 유튜브와 넷플릭스를 실행한다고 해봅시다. 공유기는 이들이 사용하는 포트 번호를 각각 다르게 할당하여, 응답을 받을 때 어느 기기에 어떤 응답을 돌려줘야 하는지를 정확히 구분해냅니다.

### **NAT는 보안에도 기여한다**

NAT의 또 다른 강력한 기능은 보안입니다. NAT는 원칙적으로 **내부에서 시작된 통신만을 허용**합니다. 외부에서 내부로 직접 접근하는 시도는 기본적으로 차단되기 때문에, 의도하지 않은 외부 공격이나 스캔 시도로부터 내부 기기들을 보호할 수 있습니다.

이런 이유로 오늘날 웜 바이러스나 포트 스캐닝과 같은 공격이 과거보다 확연히 줄어들었고, P2P 통신조차도 별도의 설정 없이는 쉽게 이뤄지지 않게 되었습니다. NAT는 결과적으로 **방화벽과 유사한 효과**를 제공하는 셈입니다.

### **NAT는 모두 같은 방식으로 작동하지 않는다**

NAT도 그 구조에 따라 다르게 작동합니다. 그중 대표적인 두 가지 구조는 **Symmetric NAT**와 **Cone NAT**입니다.

Symmetric NAT는 요청을 보낼 때마다 외부로 나가는 포트 번호를 계속 바꾸는 방식입니다. 즉, 같은 내부 장치가 동일한 외부 서버에 요청하더라도, 매번 다른 외부 포트로 나가게 됩니다. 이 방식은 보안성이 높지만, 외부에서 이 장치로 직접 접근하기가 거의 불가능합니다. 그래서 일부 P2P 어플리케이션은 작동이 어렵거나 제한되기도 합니다.

반대로 Cone NAT는 내부 주소와 포트가 한 번 외부로 매핑되면, 그 매핑이 일정 시간 유지됩니다. 덕분에 외부 장치가 NAT의 외부 주소와 포트를 알고 있다면, 해당 장치에 다시 연결할 수 있게 됩니다. 접근성이 좋다는 점에서 P2P 환경에 적합하지만, 보안성은 상대적으로 낮습니다.

---

## **Symmetric NAT 방식**

우리가 인터넷을 사용할 때는 대부분 공유기를 통해 인터넷에 연결됩니다. 가장 엄격한 방식이 **Symmetric NAT**입니다.

### **1. Symmetric NAT의 작동 배경과 기본 원리**

일반적인 NAT는 내부의 사설 IP 주소를 외부로 나갈 때 공인 IP로 변환합니다. 그런데 **Symmetric NAT**는 이 과정에서 ‘포트 번호’까지 철저히 관리합니다. 즉, 내부의 특정 호스트가 외부에 연결을 시도할 때마다, 단순히 IP 주소만을 변경하는 것이 아니라 IP 주소와 포트 번호 둘 다를 변경합니다.

 **“내부 호스트와 외부 호스트가 통신할 때마다 매번 다른 외부 포트 번호를 부여”** 합니다. 내부 장치가 같은 내부 포트를 사용하더라도, 연결하는 외부 서버의 IP 주소나 포트가 다르면 매번 전혀 다른 외부 포트를 할당하여 관리합니다. 이로 인해 외부에서 내부로 연결하려 할 때, 연결 요청이 성공하기 위해서는 반드시 정확히 일치하는 매핑 정보(IP, 포트 번호)를 미리 갖추고 있어야 합니다.


### **2. Symmetric NAT의 실제 패킷 흐름과 변환 과정**

내부 네트워크에 위치한 컴퓨터 한 대가 있습니다. 이 컴퓨터의 사설 IP 주소는 192.168.0.10이며, 브라우저에서 웹사이트(abc.com)에 접속하려 합니다. abc.com 웹서버의 실제 IP 주소는 15.15.15.15라고 가정하겠습니다. 이 PC는 운영체제로부터 랜덤한 포트를 할당받아 TCP 연결을 시작합니다(예: 내부 포트 3000).

이 요청 패킷이 NAT 장비(공유기)를 지나 외부로 나갈 때, NAT는 이 패킷을 그대로 보내지 않고 반드시 변조를 수행합니다. 원본 패킷의 출발지 IP(192.168.0.10)와 포트(3000)는 내부망에서만 유효한 정보이므로 인터넷망에서 사용할 수 없습니다. 따라서 NAT 장비는 이 정보를 다음과 같이 변환합니다.

- **출발지 IP:** 192.168.0.10 → 3.3.3.3 (공인 IP)
    
- **출발지 포트:** 3000 → 외부에 사용 가능한 랜덤 포트 번호(23000)

|**내부망 (원본)**|**NAT 통과 후 (변환됨)**|
|---|---|
|192.168.0.10 : 3000 →|3.3.3.3 : 23000|
![](https://velog.velcdn.com/images/bini/post/1e89a9ba-a921-44cf-87a9-248295eaeffa/image.png)

### **3. NAT 테이블의 생성과 관리 방식**

Symmetric NAT의 핵심은 ‘NAT 테이블’입니다. NAT 테이블은 NAT 장비 내부에서 유지하는 자료구조로, **내부 호스트의 원본 IP/포트 정보와 외부로 변환된 IP/포트 정보의 매핑을 저장한 데이터베이스**입니다.

이 NAT 테이블은 반드시 내부에서 외부로 나가는 트래픽(outbound)이 발생했을 때만 생성됩니다. 즉, 외부에서 내부로 들어오는 최초의 연결 시도(inbound)는 NAT 테이블에 존재하지 않으므로 항상 차단됩니다. 오직 내부에서 먼저 요청이 있어야만 매핑 정보가 생성되며, 이후 이 정보를 기준으로 외부에서 들어오는 응답 패킷이 다시 내부로 전달될 수 있습니다.

| **내부 IP**    | **내부 Port** | **외부 목적지 IP** | **외부 목적지 Port** | **NAT 외부 IP** | **NAT 외부 Port** |
| ------------ | ----------- | ------------- | --------------- | ------------- | --------------- |
| 192.168.0.10 | 3000        | 15.15.15.15   | 80              | 3.3.3.3       | 23000           |

### **4. Symmetric NAT의 보안성과 한계**

Symmetric NAT는 외부에서의 무작위 연결을 원천적으로 차단하기 때문에 보안 측면에서 매우 강력합니다. 예측 불가능한 외부 포트 매핑과 내부 요청이 없으면 NAT 테이블 자체가 만들어지지 않는 구조 덕분에, 무작위로 외부에서 침입하거나 공격하는 것이 불가능합니다.

하지만 이 특성 때문에 **양방향 연결이 필요한 실시간 서비스(P2P 게임, 화상 회의, WebRTC 등)** 는 NAT 통과가 어렵습니다. Symmetric NAT 방식은 외부에서 내부로 직접 접근을 허용하지 않기 때문입니다. 이런 환경에서는 중계 서버(STUN/TURN 서버)를 활용하거나 복잡한 NAT traversal 알고리즘을 사용해야만 합니다.

![[Pasted image 20250603203911.png]]

---
## **Full Cone NAT 방식의 이해와 내부 네트워크 접속 문제**

### **1. Full Cone 방식의 특징**

**Full Cone NAT 방식**은 좀 더 개방적이고 유연합니다. 내부의 특정 장치가 한번 외부 인터넷과 연결되면, 이때 생성된 NAT 테이블 항목을 기반으로 이후 외부의 어떠한 호스트로부터라도 해당 내부 장치로 연결이 허용됩니다. 즉, 내부 장치가 외부로 나갈 때 단 하나의 외부 포트를 사용하여 고정된 NAT 테이블 매핑을 생성합니다. 이 매핑은 외부 상대방의 IP 주소나 포트 번호에 관계없이 항상 동일하게 유지됩니다.

### **2. Full Cone NAT 방식의 작동 원리**

구체적인 예를 들어 설명하겠습니다. 내부 네트워크의 장치가 사설 IP 주소 192.168.0.10을 가지고 있다고 가정합니다. 이 장치가 외부에 위치한 웹서버 A(15.15.15.15)와 통신하기 위해 내부에서 임의의 포트(예: 3000번)를 열어 접속을 시도합니다.

이때 NAT 장비(공유기)는 이 연결 요청이 외부로 나갈 때 다음과 같이 변환하여 NAT 테이블에 저장합니다.

|**내부 IP**|**내부 Port**|**외부 IP(공인 IP)**|**외부 Port(공인 Port)**|
|---|---|---|---|
|192.168.0.10|3000|3.3.3.3|8080|

이 테이블이 생성된 이후부터는 외부에서 이 공인 주소(3.3.3.3:8080)로 오는 어떠한 접속도 내부의 원본 주소(192.168.0.10:3000)로 전달됩니다. 외부 IP 주소나 포트 번호가 다르더라도 NAT 테이블의 외부 포트(8080)만 동일하면 모두 내부로 진입 가능한 것이죠.

예를 들어, 최초에 웹서버 A(15.15.15.15)와 접속한 이후, 또 다른 웹서버 B(9.9.9.9)가 같은 외부 포트(8080)를 통해 연결을 요청한다면, NAT는 별도의 추가적인 인증이나 제한 없이 그대로 내부의 장치(192.168.0.10)로 전달해 줍니다.

![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FtAgjf%2FbtskSShfgZB%2FK6k1SFAeQlOp9sxZAfQTfK%2Fimg.png)

### **3. Full Cone NAT 방식의 장점과 내부 네트워크 접속 문제 해결**

이러한 특성 때문에 Full Cone NAT 방식은 게임과 같은 P2P 연결이 많은 환경에서 큰 장점을 발휘합니다. 게임에서는 클라이언트 간 직접 연결을 통한 통신이 빈번히 일어나는데, 중계 서버를 거치지 않고 직접 연결을 할 수 있어야 속도가 빨라지고 응답성이 좋아집니다.

Full Cone NAT를 사용할 때는 이른바 ’홀 펀칭(Hole Punching)’이라는 방식이 가능합니다. 홀 펀칭이란 내부에서 외부로 미리 특정 포트를 한번 열어두면, 외부에서 임의의 장치가 이 포트를 통해 직접 접속하는 기술입니다. 이렇게 하면 랑데부 서버라는 중계 서버가 한 번만 연결 정보를 전달하면, 이후 클라이언트끼리 직접 연결이 가능합니다. 이는 P2P 게임, VoIP(인터넷 전화), 화상회의 같은 서비스에서 사용됩니다.

### **4. 보안적 문제와 고려해야 할 부분들**

Full Cone NAT에서는 한 번이라도 NAT 테이블에 포트가 기록되면, 이후 해당 포트를 통해 임의의 외부 호스트에서 연결이 들어올 때 별도의 추가적인 보안 필터링 없이 연결이 내부로 전달됩니다. 이로 인해 의도하지 않은 외부의 접근이 발생할 가능성도 존재하게 되는 것이죠. 더 심각한 경우라면 외부에서의 무작위 접근 시도가 내부 장치에 직접적으로 영향을 미칠 수도 있습니다.

또한 NAT 테이블의 포트 충돌로 인해 원하지 않은 내부 장치로 트래픽이 전달되는 상황도 발생할 수 있습니다. 이러한 이유로, 보안이 엄격한 기업이나 기관에서는 일반적으로 Symmetric NAT와 같은 폐쇄적이고 엄격한 방식을 선택하는 경우가 많습니다.

---

## **Restricted Cone NAT 방식의 작동 원리**

### **1.  Restricted Cone NAT**

Full Cone NAT 방식은 매우 유연합니다. 내부 클라이언트가 한 번 외부로 데이터를 전송하면, 외부에서 그에 대응하는 포트로 들어오는 패킷은 **누가 보냈든 간에** 모두 허용합니다.

이 말은 즉, 공격자든 제3자든 그 포트만 알고 있으면 해당 내부 장치에 접근이 가능하다는 뜻이기도 하죠. 보안적으로는 허점이 많다는 이야기입니다.

그래서 나온 대안이 바로 Restricted Cone NAT 방식입니다. 이 방식은 **Full Cone의 문제를 인지하고, 외부 응답을 일정한 기준에 따라 제한**합니다. 이를 통해 불특정 다수로부터의 접근을 막고, **이전에 통신한 상대에게만 응답을 허용**하는 보다 보안에 초점을 맞춘 구조를 갖추게 됩니다.

### **2. Restricted Cone NAT의 동작 방식**

Restricted Cone NAT는 “Restricted”라는 단어에서 알 수 있듯이, 포트 개방의 조건을 제한합니다. 이 제한은 두 가지 방향으로 이루어질 수 있습니다.
1. **IP-Restricted Cone** (기본형)
    → 외부에서 접속을 허용하려면, 이전에 통신한 **외부 IP 주소와 같아야** 함
2. **Port-Restricted Cone**
    → 외부에서 접속을 허용하려면, 이전에 통신한 **IP 주소뿐 아니라 포트 번호까지 동일해야** 함

일반적으로 “Restricted Cone NAT”라고 하면 첫 번째인 IP-Restricted Cone을 의미합니다.

![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FZxYHB%2FbtskZkXXgUc%2FuMjUvjaDyXWbPqJjCbXj3K%2Fimg.png)

---

## Port Restricted Cone 방식

Port Restricted Cone NAT: 위 조건에 추가로, 외부 **IP와 포트 모두 일치**해야 접근 가능

### **1. Port Restricted Cone NAT의 작동 원리**

Port Restricted Cone NAT에서는 NAT 테이블에 기록된 **외부 대상의 IP와 포트가 완전히 일치**해야만, 해당 외부 호스트의 응답이 내부로 전달됩니다.

| **내부 IP**    | **내부 Port** | **외부 IP**   | **외부 Port** | **NAT 외부 Port** |
| ------------ | ----------- | ----------- | ----------- | --------------- |
| 192.168.0.10 | 3000        | 15.15.15.15 | 5555        | 8080            |

### **2. Symmetric NAT차이**

| **항목**        | **Port Restricted Cone NAT** | **Symmetric NAT** |
| ------------- | ---------------------------- | ----------------- |
| NAT 외부 포트 재사용 | 가능한 한 유지                     | 세션마다 다르게 부여       |
| 동일 목적지 재접속    | 같은 포트 유지 가능                  | 포트 무조건 새로 할당      |
| NAT 테이블 유지 방식 | 대상 IP+Port 기준 단일 매핑          | 세션 단위로 각각 별도 매핑   |
| P2P 통신 난이도    | 중간                           | 매우 어려움            |

![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FlZ19f%2FbtskS2EdaR5%2FXswxnZXwhEJhBuyd9Cn2kK%2Fimg.png)


### **3. Port Restricted Cone NAT**

- **내부 IP+내부 Port**를 기준으로 한 번 매핑을 생성하면,
    그 매핑은 **“어떤 목적지(IP:Port)로 나가든” 동일한 공인 포트를 계속 재사용**합니다.

1. 192.168.0.10:3000 → 10.10.10.10:555  
2. 192.168.0.10:3000 → 10.10.10.10:556  
3. 192.168.0.10:3000 → 8.8.8.8:80  

모두 공인 포트 203.0.113.5:40000 하나를 쓰게 됩니다.